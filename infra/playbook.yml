---
- hosts: local
  gather_facts: yes
  vars:
    packages: [zsh, asdf, chezmoi, age]
    
    paths:
      home: "{{ ansible_env.HOME }}"
      chezmoi_config: "{{ ansible_env.HOME }}/.config/chezmoi"
      age_config: "{{ ansible_env.HOME }}/.config/age"
      age_key: "{{ ansible_env.HOME }}/.config/age/age.key"
      chezmoi_source: "{{ ansible_env.HOME }}/.local/share/chezmoi"
      zprofile: "{{ ansible_env.HOME }}/.zprofile"
      zshrc: "{{ ansible_env.HOME }}/.zshrc"
      tool_versions: "{{ ansible_env.HOME }}/.tool-versions"

    brew_configs:
      Darwin_arm64: &darwin_arm
        bin: "/opt/homebrew/bin"
        prefix: "/opt/homebrew"
        zsh: "/opt/homebrew/bin/zsh"
      Darwin_aarch64: *darwin_arm
      Darwin_x86_64: &darwin_intel
        bin: "/usr/local/bin"
        prefix: "/usr/local"
        zsh: "/usr/local/bin/zsh"
      Darwin_i386: *darwin_intel
      Debian_default: &linux_brew
        bin: "/home/linuxbrew/.linuxbrew/bin"
        prefix: "/home/linuxbrew/.linuxbrew"
        zsh: "/home/linuxbrew/.linuxbrew/bin/zsh"

  pre_tasks:
    - name: Display system information
      debug:
        msg: "Platform: {{ ansible_facts.os_family }}/{{ ansible_facts.machine }}"

    - name: Set platform-specific configuration
      set_fact:
        brew: "{{ brew_configs[ansible_facts.os_family + '_' + ansible_facts.machine] | default(brew_configs[ansible_facts.os_family + '_default'], {}) }}"

    - name: Validate platform support
      fail:
        msg: "Unsupported platform: {{ ansible_facts.os_family }}/{{ ansible_facts.machine }}"
      when: brew == {}

    - name: Set asdf configuration
      set_fact:
        asdf_sh: "{{ brew.prefix }}/opt/asdf/libexec/asdf.sh"
        asdf_env:
          ASDF_DIR: "{{ brew.prefix }}/opt/asdf/libexec"
          PATH: "{{ ansible_env.PATH }}:{{ brew.prefix }}/opt/asdf/shims:{{ brew.prefix }}/opt/asdf/bin"

  tasks:
    - name: Check Homebrew installation
      command: "{{ brew.bin }}/brew --version"
      register: brew_check
      changed_when: false
      failed_when: false

    - name: Prepare Homebrew installation directories (Linux)
      block:
        - name: Create /home/linuxbrew directory
          file:
            path: /home/linuxbrew
            state: directory
            mode: '0755'
            owner: "{{ ansible_user_id }}"
            group: "{{ ansible_user_id }}"
          become: yes

        - name: Create /home/linuxbrew/.linuxbrew directory
          file:
            path: /home/linuxbrew/.linuxbrew
            state: directory
            mode: '0755'
            owner: "{{ ansible_user_id }}"
            group: "{{ ansible_user_id }}"
          become: yes
      when:
        - brew_check.rc != 0
        - ansible_facts.os_family == "Debian"

    - name: Install Homebrew
      shell: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      when: brew_check.rc != 0
      environment:
        NONINTERACTIVE: "1"
        HOME: "{{ paths.home }}"
        USER: "{{ ansible_user_id }}"

    - name: Install essential system dependencies
      block:
        - name: Install core dependencies (Debian/Ubuntu)
          apt:
            name: 
              - build-essential
              - unzip
              - curl
              - wget
              - git
              - gnupg
              - dirmngr
              - ca-certificates
              - software-properties-common
              - libssl-dev
              - libffi-dev
              - zlib1g-dev
              - libbz2-dev
              - libreadline-dev
              - libsqlite3-dev
              - xz-utils
            update_cache: yes
            state: present
          become: yes
          when: ansible_facts.os_family == "Debian"

        - name: Install core dependencies (macOS)
          community.general.homebrew:
            name:
              - unzip
              - gnupg
            state: present
          when: ansible_facts.os_family == "Darwin"

    - name: Check existing packages
      command: "{{ brew.bin }}/brew list --versions {{ item }}"
      loop: "{{ packages }}"
      register: package_check
      changed_when: false
      failed_when: false

    - name: Install missing packages
      shell: "{{ brew.bin }}/brew install {{ item.item }}"
      loop: "{{ package_check.results }}"
      when: item.rc != 0

    - name: Configure zsh as default shell and install zplug
      block:
        - name: Install zplug plugin manager
          git:
            repo: "https://github.com/zplug/zplug"
            dest: "{{ paths.home }}/.zplug"
            version: "master"
            update: no

        - name: Register zsh in /etc/shells
          lineinfile:
            path: /etc/shells
            line: "{{ brew.zsh }}"
            state: present
          become: yes

        - name: Get current shell
          command: /bin/sh -lc 'echo "$SHELL"'
          register: current_shell
          changed_when: false

        - name: Set default shell to zsh
          user:
            name: "{{ ansible_user_id }}"
            shell: "{{ brew.zsh }}"
          become: yes
          when: current_shell.stdout != brew.zsh

    - name: Setup encryption and dotfiles management
      block:
        - name: Create configuration directories
          file:
            path: "{{ item.path }}"
            state: directory
            mode: "{{ item.mode }}"
          loop:
            - { path: "{{ paths.chezmoi_config }}", mode: '0755' }
            - { path: "{{ paths.age_config }}", mode: '0700' }

        - name: Deploy age private key
          copy:
            content: "{{ age_private_key_content }}"
            dest: "{{ paths.age_key }}"
            mode: '0600'
          no_log: true

        - name: Extract age public key
          command: "{{ brew.bin }}/age-keygen -y {{ paths.age_key }}"
          register: age_public_key
          changed_when: false

        - name: Generate chezmoi configuration
          template:
            src: chezmoi.toml.j2
            dest: "{{ paths.chezmoi_config }}/chezmoi.toml"
            mode: '0644'
          vars:
            age_public_key: "{{ age_public_key.stdout.strip() }}"
            age_key_file: "{{ paths.age_key }}"
            brew_bin: "{{ brew.bin }}"
            brew_prefix: "{{ brew.prefix }}"
            asdf_dir: "{{ brew.prefix }}/opt/asdf/libexec"
            asdf_sh: "{{ brew.prefix }}/opt/asdf/libexec/asdf.sh"

        - name: Check existing repository
          stat:
            path: "{{ paths.chezmoi_source }}"
          register: repo_exists

        - name: Initialize chezmoi repository
          command: "{{ brew.bin }}/chezmoi init {{ chezmoi_repo_url }}"
          when: not repo_exists.stat.exists

        - name: Update existing repository
          command: "git -C {{ paths.chezmoi_source }} pull"
          register: git_pull
          changed_when: "'Already up to date.' not in git_pull.stdout"
          when: repo_exists.stat.exists

        - name: Verify configuration
          command: "{{ brew.bin }}/chezmoi doctor"
          register: doctor_result
          changed_when: false

        - name: Check if dotfiles need to be applied
          command: "{{ brew.bin }}/chezmoi diff"
          register: chezmoi_diff_check
          changed_when: false
          failed_when: false

        - name: Apply dotfiles
          command: "{{ brew.bin }}/chezmoi apply"
          register: apply_result
          no_log: true
          when: chezmoi_diff_check.stdout != ""

        - name: Create asdf compatibility symlink
          file:
            src: "{{ brew.prefix }}/opt/asdf"
            dest: "{{ paths.home }}/.asdf"
            state: link
            force: yes

        - name: Get final status
          command: "{{ brew.bin }}/chezmoi status"
          register: final_status
          changed_when: false

      environment:
        AGE_IDENTITIES_FILE: "{{ paths.age_key }}"

    - name: Verify zsh configuration
      block:
        - name: Check if .zshrc exists
          stat:
            path: "{{ paths.zshrc }}"
          register: zshrc_final_check

        - name: Test zsh configuration syntax
          shell: "{{ brew.zsh }} -n {{ paths.zshrc }}"
          register: zsh_syntax_check
          changed_when: false
          failed_when: false
          when: zshrc_final_check.stat.exists

        - name: Test interactive zsh loading
          shell: "timeout 10 {{ brew.zsh }} -i -c 'echo ZSH_LOADED_OK && exit 0'"
          register: zsh_interactive_test
          changed_when: false
          failed_when: false
          when: zshrc_final_check.stat.exists

        - name: Display verification results
          debug:
            msg:
              - "=== ZSH Configuration Verification ==="
              - ".zshrc exists: {{ 'YES' if zshrc_final_check.stat.exists else 'NO' }}"
              - "Syntax Check: {{ 'PASSED' if (zshrc_final_check.stat.exists and zsh_syntax_check.rc == 0) else 'SKIPPED/FAILED' }}"
              - "Interactive Load: {{ 'PASSED' if (zshrc_final_check.stat.exists and zsh_interactive_test.rc == 0) else 'SKIPPED/FAILED' }}"

    - name: Check .tool-versions file exists
      stat:
        path: "{{ paths.tool_versions }}"
      register: tool_versions_file

    - name: Setup asdf version management
      block:
        - name: Read .tool-versions content
          slurp:
            src: "{{ paths.tool_versions }}"
          register: tool_versions_raw

        - name: Parse .tool-versions content
          set_fact:
            asdf_tools: >-
              {{
                (tool_versions_raw.content | b64decode).splitlines()
                | map('trim')
                | reject('match', '^(#|$)')
                | map('regex_findall', '(\S+)')
                | list
              }}

        - name: Display detected tools
          debug:
            msg: "Detected asdf tools: {{ asdf_tools | map('join', ' ') | list | join(', ') }}"
          when: asdf_tools is defined and asdf_tools | length > 0

        - name: Get currently installed plugins
          shell: '. "{{ asdf_sh }}" && asdf plugin list'
          register: installed_plugins
          changed_when: false
          failed_when: false
          args:
            executable: /bin/bash

        - name: Install missing asdf plugins
          shell: '. "{{ asdf_sh }}" && asdf plugin add {{ item[0] }}'
          loop: "{{ asdf_tools }}"
          when: 
            - asdf_tools is defined
            - item[0] not in (installed_plugins.stdout_lines | default([]))
          failed_when: false
          args:
            executable: /bin/bash

        - name: Check nodejs keyring status
          stat:
            path: "{{ paths.home }}/.gnupg/pubring.gpg"
          register: nodejs_keyring_check
          when: 
            - asdf_tools is defined
            - asdf_tools | map('first') | list | select('match', 'nodejs') | list | length > 0

        - name: Handle nodejs plugin requirements
          shell: '. "{{ asdf_sh }}" && bash ~/.asdf/plugins/nodejs/bin/import-release-team-keyring'
          when: 
            - asdf_tools is defined
            - asdf_tools | map('first') | list | select('match', 'nodejs') | list | length > 0
            - not nodejs_keyring_check.stat.exists
          failed_when: false
          args:
            executable: /bin/bash

        - name: Check currently installed tool versions
          shell: '. "{{ asdf_sh }}" && asdf current {{ item[0] }} 2>/dev/null | grep "{{ item[1] }}" || echo "not_installed"'
          loop: "{{ asdf_tools }}"
          register: current_tool_versions
          failed_when: false
          changed_when: false
          when: asdf_tools is defined
          args:
            executable: /bin/bash

        - name: Identify tools that need installation
          set_fact:
            tools_to_install: >-
              {{
                asdf_tools | zip(current_tool_versions.results)
                | selectattr('1.stdout', 'match', 'not_installed')
                | map('first')
                | list
              }}
          when: 
            - asdf_tools is defined
            - current_tool_versions.results is defined

        - name: Display tools that need installation
          debug:
            msg: "Tools to install: {{ tools_to_install | map('join', ' ') | list | join(', ') }}"
          when: 
            - tools_to_install is defined
            - tools_to_install | length > 0

        - name: Display already installed tools
          debug:
            msg: "Already installed tools (skipping): {{ asdf_tools | difference(tools_to_install) | map('join', ' ') | list | join(', ') }}"
          when: 
            - asdf_tools is defined
            - tools_to_install is defined
            - (asdf_tools | length) > (tools_to_install | length)

        - name: Install missing tools from .tool-versions
          shell: '. "{{ asdf_sh }}" && cd "{{ paths.home }}" && asdf install {{ item[0] }} {{ item[1] }}'
          loop: "{{ tools_to_install }}"
          when: 
            - tools_to_install is defined
            - tools_to_install | length > 0
          args:
            executable: /bin/bash

        - name: Reshim asdf executables
          shell: '. "{{ asdf_sh }}" && asdf reshim'
          changed_when: false
          when: 
            - tools_to_install is defined
            - tools_to_install | length > 0
          args:
            executable: /bin/bash

        - name: Verify asdf current versions
          shell: '. "{{ asdf_sh }}" && asdf current'
          register: asdf_current
          changed_when: false
          when: asdf_tools is defined
          args:
            executable: /bin/bash

        - name: Display installed versions
          debug:
            msg: "{{ asdf_current.stdout_lines }}"
          when: 
            - asdf_tools is defined
            - asdf_current.stdout_lines is defined

      environment: "{{ asdf_env }}"
      when: tool_versions_file.stat.exists

    - name: Display skip message
      debug:
        msg: "Skipping asdf setup: .tool-versions file not found at {{ paths.tool_versions }}"
      when: not tool_versions_file.stat.exists

    - name: Discover custom scripts
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/bin"
        patterns: "*.sh"
        file_type: file
      register: custom_scripts_found

    - name: Build structured script information
      set_fact:
        custom_scripts_info: >-
          {{
            (custom_scripts_info | default([])) + [{
              'name': (item | basename | regex_replace('\.sh$', '')),
              'path': item
            }]
          }}
      loop: "{{ custom_scripts_found.files | map(attribute='path') | list }}"
      when: (custom_scripts_found.matched | default(0)) > 0

    - name: Check if target commands already exist
      shell: |
        command -v {{ item.name }}
      register: command_existence_check
      changed_when: false
      failed_when: false
      loop: "{{ custom_scripts_info | default([]) }}"
      loop_control:
        label: "{{ item.name }}"
        index_var: script_index
      environment:
        PATH: "{{ brew.bin }}:{{ ansible_env.PATH }}"
        HOME: "{{ paths.home }}"

    - name: Execute custom scripts for missing commands
      shell: |
        echo "Installing {{ item.name }}..."
        chmod +x "{{ item.path }}"
        "{{ item.path }}"
      register: custom_script_execution
      failed_when: false
      changed_when: custom_script_execution.rc == 0
      loop: "{{ custom_scripts_info | default([]) }}"
      loop_control:
        label: "{{ item.name }}"
        index_var: script_index
      when: command_existence_check.results[script_index].rc != 0
      environment:
        HOME: "{{ paths.home }}"
        BREW_BIN: "{{ brew.bin }}"
        BREW_PREFIX: "{{ brew.prefix }}"
        OS_FAMILY: "{{ ansible_facts.os_family }}"
        ARCH: "{{ ansible_facts.machine }}"
        PATH: "{{ brew.bin }}:{{ ansible_env.PATH }}"
    
    - name: Final verification and comprehensive summary
      block:
        - name: Check standard tool versions
          command: "{{ brew.bin }}/{{ item }} --version"
          loop: "{{ packages }}"
          register: standard_versions
          changed_when: false
          failed_when: false

        - name: Build custom script summary with enhanced safety
          set_fact:
            custom_success: >-
              {{
                (custom_script_execution.results | default([]))
                | rejectattr('skipped', 'defined')
                | selectattr('rc', 'defined')
                | selectattr('rc', 'equalto', 0)
                | map(attribute='item')
                | map(attribute='name')
                | list
              }}
            custom_failed: >-
              {{
                (custom_script_execution.results | default([]))
                | rejectattr('skipped', 'defined')
                | selectattr('rc', 'defined')
                | rejectattr('rc', 'equalto', 0)
                | map(attribute='item')
                | map(attribute='name')
                | list
              }}
            custom_skipped: >-
              {{
                (command_existence_check.results | default([]))
                | selectattr('rc', 'defined')
                | selectattr('rc', 'equalto', 0)
                | map(attribute='item')
                | map(attribute='name')
                | list
              }}


        - name: Display comprehensive setup summary
          debug:
            msg:
              - "================================================="
              - "ğŸš€ Development Environment Setup Complete! ğŸš€"
              - "================================================="
              - ""
              - "ğŸ“¦ Standard Tools: {{ standard_versions.results | selectattr('rc', 'equalto', 0) | map(attribute='item') | list | join(', ') }}"
              - "ğŸ”§ ASDF Tools: {{ asdf_tools | map('join', ' ') | list | join(', ') if asdf_tools is defined else 'None detected' }}"
              - "ğŸ› ï¸  Custom Scripts:"
              - "   âœ… Success: {{ custom_success | join(', ') if custom_success | length > 0 else 'None' }}"
              - "   â­ï¸  Skipped: {{ custom_skipped | join(', ') if custom_skipped | length > 0 else 'None' }}"
              - "   âŒ Failed: {{ custom_failed | join(', ') if custom_failed | length > 0 else 'None' }}"
              - ""
              - "ğŸ” Security: Enabled (age encryption)"
              - "ğŸ“ Dotfiles: {{ final_status.stdout_lines | join(', ') if final_status.stdout_lines else 'Clean' }}"
              - "âš™ï¸  Configuration: {{ paths.chezmoi_config }}/chezmoi.toml"
              - ""
              - "ğŸ‰ Ready to code! ğŸ‰"
              - "================================================="
